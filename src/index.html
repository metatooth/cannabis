<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hello Herbert!</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <script src="https://kit.fontawesome.com/f2e9d13f99.js" crossorigin="anonymous"></script>
    <style>
      .display {
          border: 0;
          width: 30px;
      }
    </style>
  </head>
  <body>
    <section class="section">
      <div>
	<div>
	  <img width="40" src="JD-15-512.png"/>
	</div>
	<div>
	  <h1 class="title">Herbert</h1>
	  <h2 class="subtitle">Grow More</h2>
	</div>
      </div>
    </section>
    <section class="section">
      <div class="columns">
        <div class="column is-two-thirds">
          <h1 class="title">Environments</h1>
          <div class="columns">
            <div id="displays" class="column">
            </div>
          </div>
        </div>
        <div class="column">
          <h1 class="title">Pings</h1>
          <ul id="pings"></ul>
        </div>
      </div>
    </section>
    <script>
      function observable(value) {
          const listeners = [];

          function notify(newValue) {
              listeners.forEach((listener) => { listener(newValue); });
          }

          function accessor(newValue) {
              if (arguments.length && newValue !== value) {
                  value = newValue;
                  notify(newValue);
              }
              return value;
          }

          accessor.subscribe = (listener) => { listeners.push(listener); };

          return accessor;
      }

      function bindValue(input, observable, precision) {
          input.value = observable();
          observable.subscribe(() => { input.value = observable().toFixed(precision); });
      }

      function zeroes(n) {
          if (n < 10) {
              return '0' + n;
          }
          return n;
      }

      function createStatus(name, state) {
	  const status = document.createElement('div');

	  let mod = 'is-warning';
	  if (state === true) {
	      mod = 'is-success';
	  }

	  status.setAttribute('class', 'button ' + mod);
	  status.appendChild(document.createTextNode(name));

	  return status;
      }

      function createReadout(icon, name, text) {
          const readout = document.createElement('div');
          const span = document.createElement('span');
          span.setAttribute('class', 'icon');
          const i = document.createElement('i');
          i.setAttribute('class', 'fas fa-'+icon);
          span.appendChild(i);
          readout.appendChild(span);
          const display = document.createElement('span');
          const input = document.createElement('input');
          input.setAttribute('class', 'display');
          input.setAttribute('type', 'text');
          input.setAttribute('id', name);
          display.appendChild(input);
          display.appendChild(document.createTextNode(text));
          readout.appendChild(display);

          return readout;
      }

      function createDisplay(data) {
          const display = document.createElement('div');
          display.setAttribute('id', data.id);
          display.setAttribute('class', 'tile');

          const title = document.createElement('h2');
          title.appendChild(document.createTextNode(data.id));

          display.appendChild(title);

	  const blower = createStatus('blower', data.blower);
	  display.appendChild(blower);

	  const dehumidifier = createStatus('dehumidifier', data.dehumidifier);
	  display.appendChild(dehumidifier);

	  const heater = createStatus('heater', data.heater);
	  display.appendChild(heater);

	  const humidifier = createStatus('humidifier', data.humidifier);
	  display.appendChild(humidifier);

	  const lamp = createStatus('lamp', data.lamp);
	  display.appendChild(lamp);

          const temp = createReadout('thermometer-half', data.id+'-temp', 'Â°C');
          display.appendChild(temp);

          const humid = createReadout('tint', data.id+'-humidity', '%');
          display.appendChild(humid);

          return display;
      }

      function createPing(data) {
          const date = new Date(data.updated_at);
          const at = `${zeroes(date.getHours())}:${zeroes(date.getMinutes())}:${zeroes(date.getSeconds())}`;
          let entry = `${at}&nbsp;`;
          entry += `${data.id}&nbsp;`;
          entry += `${data.temperature.toFixed(1)}&#176;C&nbsp;`;
          entry += `${(100*data.humidity).toFixed(0)}%&nbsp;`;

          const li = document.createElement('li');
          li.innerHTML = entry;

          return li;
      }

      const climes = new Map();

      const host = location.origin.replace(/^http/, 'ws')

      function startWebSocket() {
	  let ws = new WebSocket(host);

	  ws.onmessage = (event) => {
              console.log(event.data);
              const data = JSON.parse(event.data);

              let display = document.querySelector('#' + data.id);
              if (display === null) {
		  display = createDisplay(data);
		  document.querySelector('#displays').appendChild(display);

		  climes.set(data.id, [0, 0]);
		  const clime = climes.get(data.id);

		  clime[0] = observable(data.temperature);
		  const ttext = document.getElementById(data.id+'-temp');
		  bindValue(ttext, clime[0], 1);

		  clime[1] = observable(data.humidity);
		  const htext = document.getElementById(data.id+'-humidity');
		  bindValue(htext, clime[1], 0);
              }

	      const clime = climes.get(data.id);

	      clime[0](data.temperature);
	      clime[1](100*data.humidity);

	      const ping = createPing(data);
	      const pings = document.querySelector('#pings');
	      pings.insertBefore(ping, pings.childNodes[0]);
	  }

	  ws.onclose = () => {
	      console.log('websocket is closed! reconnecting...');
	      ws = null;
	      setTimeout(startWebSocket, 5000);
	  }
      }

      startWebSocket();
    </script>
  </body>
</html>
