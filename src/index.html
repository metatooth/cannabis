<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hello Herbert!</title>
  <style>
    .display {
        border: 0;
        width: 30px;
        background: #f5f5f5;
    }
    .hhmm {
        border: 0;
        width: 60px;
	      background: #ffffff;
    } 
    .ss {
        border: 0;
        width: 60px;
	      background: #ffffff;
	      align: left;
    }
    .card {
	      margin: 20px;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
  <script src="https://kit.fontawesome.com/f2e9d13f99.js" crossorigin="anonymous"></script>  
</head>
<body>
  <div class="container">
    <nav class="navbar">
      <div class="navbar-brand">
        <a class="navbar-item" href="/">
          <img src="logo.png"/>
        </a>
      </div>
    </nav>
  </div>
  <div class="container">
    <section class="section">
      <div id="notifications"></div>
    </section>
    <section class="section">
      <div class="columns">
        <div class="column is-two-thirds">
          <div id="displays" class="tile is-ancestor">
          </div>
        </div>
        <div class="column is-hidden">
	        <form class="control">
            <label class="radio">
              <input type="radio" name="units" onclick="setUnits('C')" checked>
              Celsius
            </label>
            <label class="radio">
              <input type="radio" name="units" onclick="setUnits('F')">
              Fahrenheit
            </label>
	        </form>
          <h4 class="is-italic">Pings</h4>
          <ul id="pings"></ul>
        </div>
      </div>
    </section>
  </div>
  
  <script id="header-template" type="x-tmpl-mustach">
    <p class="card-header-title">{{title}}</p>
  </script>

  <script id="ping-template" type="x-tmpl-mustache">
    <span class="is-family-code">
    {{hhmm}}<span class="is-size-7">:{{ss}}</span>
    <span class="is-uppercase">{{name}}</span> &nbsp;
    {{temperature}}&#176;{{units}} &nbsp;
    {{humidity}}%
    </span>
  </script>

  <script id="readout-template" type="x-tmpl-mustach">
    <span class="icon"><i class="{{icon}}"></i></span>
    <span><input class="display" type="text" id="{{id}}" disabled>{{units}}</span>
  </script>

  <script id="timestamp-template" type="x-tmpl-mustache">
    <input id="{{hhmm}}" type="text" class="hhmm" disabled>
    <span class="is-size-7">
    <input id="{{ss}}" type="text" class="ss" disabled>
    </span>
  </script>

  <script id="notify-template" type="x-tmpl-mustache">
    <button class="delete" onclick="this.parentNode.remove()"></button>
    <span class="is-family-code">
    {{hhmm}}<span class="is-size-7">:{{ss}}</span>
    <span class="is-uppercase">{{id}}</span> &nbsp;
    <span>{{device}}</span> &nbsp;
    <span>{{message}}</span>
</script>

  <script src="https://unpkg.com/mustache@latest"></script>

  <script>
    let UNITS = 'C';

    const SYSTEMS = [
        "blower",
        "dehumidifier",
        "heater",
        "humidifier",
        "lamp"
    ];

    const TARGETS = [
        [ "temperature", "thermometer-half", "Â°C", 1 ],
        [ "humidity", "tint", "%", 0 ],
        [ "vaporpressuredeficit", "hammer", "hPa", 1 ]
    ];
    
    const STATUSES = new Map();

    const CLIMES = new Map();

    function observable(value) {
        const listeners = [];

        function notify(newValue) {
            listeners.forEach((listener) => { listener(newValue); });
        }

        function accessor(newValue) {
            if (arguments.length && newValue !== value) {
                value = newValue;
                notify(newValue);
            }
            return value;
        }

        accessor.subscribe = (listener) => { listeners.push(listener); };

        return accessor;
    }

    function bindClass(input, observable) {
	      let onString = 'tag is-success';
	      let offString = 'tag is-warning';

	      input.setAttribute('class', observable() ? onString : offString );

	      observable.subscribe(() => {
	          if (observable()) {
		            input.setAttribute('class', onString);
	          } else {
		            input.setAttribute('class', offString);
	          }
	      });
    }

    function bindDecimalValue(input, observable, precision) {
        input.value = observable().toFixed(precision);
        observable.subscribe(() => {
            input.value = observable().toFixed(precision);
        });
    }

    function bindDisplay(data) {
        CLIMES.set(data.id, new Map());
        const clime = CLIMES.get(data.id);
        TARGETS.forEach((target) => {
	          clime.set(target[0], observable(data[target[0]]));
            const text = document.getElementById(data.id+'-'+target[0]);
            bindDecimalValue(text, clime.get(target[0]), target[3]);
        });
        
        clime.set('timestamp-hhmm', observable(hhmm(data.updated_at)));
        const htext = document.getElementById(data.id+'-timestamp-hhmm');
        bindTextValue(htext, clime.get('timestamp-hhmm'));

	      clime.set('timestamp-ss', observable(ss(data.updated_at)));
        const stext = document.getElementById(data.id+'-timestamp-ss');
        bindTextValue(stext, clime.get('timestamp-ss'));

        STATUSES.set(data.id, new Map());
        const status = STATUSES.get(data.id);
        SYSTEMS.forEach((system) => {
            status.set(system, observable(data[system]));
            const button = document.getElementById(data.id+'-'+system);
            bindClass(button, status.get(system));
        });
    }

    function bindTextValue(input, observable) {
        input.value = observable();
        observable.subscribe(() => { input.value = observable(); });
    }

    function createDisplay(data) {
        const tile = document.createElement('div');
        tile.setAttribute('class', 'tile is-6');

        const card = document.createElement('div');
        card.setAttribute('id', data.id);
        card.setAttribute('class', 'card');

        const header = document.createElement('header');
        header.setAttribute('class', 'card-header');

        let templ = document.getElementById('header-template').innerHTML;
        let params = { "id": `${data.id}-timestamp`, "title": data.id };
        header.innerHTML = Mustache.render(templ, params);
        
        card.appendChild(header);

        const content = document.createElement('div');
        content.setAttribute('class', 'card-content');

        card.appendChild(content);

        const readouts = document.createElement('div');
        readouts.setAttribute('class', 'tags are-medium');

	      TARGETS.forEach((target) => {
            const templ = document.getElementById('readout-template').innerHTML;
            const params = {
                "id": `${data.id}-${target[0]}`,
                "icon": `fas fa-${target[1]}`,
                "units": target[2]
            };
            
            const child = document.createElement('div');
            child.setAttribute('class', 'tag');
            child.innerHTML = Mustache.render(templ, params);
            readouts.appendChild(child);
        });

        const systems = document.createElement('div');
        systems.setAttribute('class', 'tags');

	      SYSTEMS.forEach((system) => {
            const child = document.createElement('div');
            child.setAttribute('id', `${data.id}-${system}`); 
            child.setAttribute('class', 'tag');
            child.appendChild(document.createTextNode(system));

            systems.appendChild(child);
        });

        content.appendChild(readouts);
        content.appendChild(systems);
        
        const footer = document.createElement('footer');
        footer.setAttribute('class', 'card-footer');

	      templ = document.getElementById('timestamp-template').innerHTML;
	      params = {
	          "hhmm": `${data.id}-timestamp-hhmm`,
	          "ss": `${data.id}-timestamp-ss`
	      };
	      const item = document.createElement('div');
	      item.setAttribute('class', 'card-footer-item');
	      item.innerHTML = Mustache.render(templ, params);

	      footer.appendChild(item);

        card.appendChild(footer);

	      tile.appendChild(card);

        return tile;
    }

    function createNotification(data) {
	      const template = document.getElementById('notify-template').innerHTML;
        const notify = {
            "id": spaces(data.id),
            "device": data.plug,
            "message": data.message,
            "hhmm": hhmm(data.timestamp),
            "ss": ss(data.timestamp)
        };
        const div = document.createElement('div');
        div.setAttribute('id', divid('notification', data.id, data.plug));
        div.setAttribute('class', 'notification is-danger');
        div.innerHTML = Mustache.render(template, notify);
        return div;
    }

    function createPing(data) {
	      const template = document.getElementById('ping-template').innerHTML;
        let temp = data.temperature.toFixed(1);
        if (UNITS === 'F') {
            temp = (data.temperature*9/5+32).toFixed(1);
        }

        const ping = {
            "hhmm": hhmm(data.updated_at),
            "ss": ss(data.updated_at),
            "name": spaces(data.id),
            "temperature": temp,
            "units": UNITS,
            "humidity": (100 * data.humidity).toFixed(0)
        }
        const rendered = Mustache.render(template, ping);
        const li = document.createElement('li');
        li.innerHTML = rendered;
        return li;
    }

    function remove(e) {
        console.log('remove', e);
    }

    function setUnits(e) {
        UNITS = e;
    }

    function spaces(text) {
	      const n = 8 - text.length;
	      if (n > 0) {
	          for (let i = 0; i < n; i++) {
		            text += '.';
	          }
	      } else if (n < 0) {
	          text = text.slice(0, 8);
	      }

	      return text;
    }

    function divid(type, id, plug) {
        const div = `${type}--${id}--${plug}`;        
        return div.split(' ').join('-');
    };

    function hhmm(at) {
        const date = new Date(at);
        return zeroes(date.getHours()) + ':' + zeroes(date.getMinutes());
    }

    function hh(at) {
        const date = new Date(at);
        return zeroes(date.getHours());
    }

    function mm(at) {
        const date = new Date(at);
        return zeroes(date.getMinutes());
    }

    function ss(at) {
        const date = new Date(at);
        return zeroes(date.getSeconds());
    }

    function saturatedVaporPressure(temp) {
        return 610.7 * Math.pow(10, 7.5 * temp / (temp + 237.3));
    }

    function vaporPressureDeficit(airTemp, leafDelta, relativeHumidity) {
        return saturatedVaporPressure(airTemp - leafDelta) -
            (relativeHumidity * saturatedVaporPressure(airTemp));
    }

    function zeroes(n) {
        if (n < 10) {
            return '0' + n;
        }
        return n;
    }

    const HOST = location.origin.replace(/^http/, 'ws')

    function startWebSocket() {
	      let ws = new WebSocket(HOST);

	      ws.onmessage = (event) => {
            console.log(event.data);
            const data = JSON.parse(event.data);

            if (data.temperature) {
                data.vaporpressuredeficit =
                    vaporPressureDeficit(data.temperature, 0.6, data.humidity)/100;
            
                let display = document.querySelector('#' + data.id);
                if (display === null) {
		                display = createDisplay(data);
		                document.querySelector('#displays').appendChild(display);
                    bindDisplay(data);
	              }

	              const clime = CLIMES.get(data.id);
	              clime.get('temperature')(data.temperature);
	              clime.get('humidity')(100*data.humidity);
	              clime.get('vaporpressuredeficit')(data.vaporpressuredeficit);
                clime.get('timestamp-hhmm')(hhmm(data.updated_at));
                clime.get('timestamp-ss')(ss(data.updated_at));
                
	              const status = STATUSES.get(data.id);
                SYSTEMS.forEach((system) => {
                    status.get(system)(data[system]);
                });
                
	              const ping = createPing(data);
	              const pings = document.querySelector('#pings');
	              pings.insertBefore(ping, pings.childNodes[0]);
	          } else if (data.code) {
                const id = `#${divid('notification', data.id, data.plug)}`;
                const doomed = document.querySelector(id);
                if (doomed) { doomed.remove(); }

                const notify = createNotification(data);
                const notifications = document.querySelector('#notifications');
                notifications.insertBefore(notify, notifications.childNodes[0]);
            }
        }

	      ws.onclose = () => {
	          console.log('websocket is closed! reconnecting...');
	          ws = null;
	          setTimeout(startWebSocket, 5000);
	      }
    }

    startWebSocket();
  </script>
</body>
</html>
